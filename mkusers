#!/bin/sh
#********************************************************************************
# Create qmail users and groups                                                 *
#                                                                               *
#   Author: Kai Peter, Â©2013 (kp@dyndn.es)                                      *
#  Version: 0.33-beta                                                           *
#  Lisence: ISC                                                                 *
#                                                                               *
# Description: I don't remember how often I did create a script to create the   *
#              necessary users ...                                              *
#              This should work on most Linux and BSD systems.                  *
#********************************************************************************
function showHelp {
  echo "Usage: mkusers [-h|--help] [-u <UID>] [-g <GID>]"
  echo
  echo -e "-h/--help"\t"Print this help."
  echo -e "-u <UID> "\t"Define the UID which should be used for the first qmail"
  echo -e "         "\t"user. UID has to be a valid numeric value (decimal). It"
  echo -e "         "\t"will be increased by 1 for each user."
  echo -e "-g <GID> "\t"Define the first GID - handled similar like UID but for"
  echo -e "         "\t"the qmail groups."
  echo
  exit 0
}
function Error { echo $ErrMsg ; exit ; }

while getopts ":hu:g:" o; do
    case "${o}" in
        u) STARTUID=${OPTARG};;
        g) STARTGID=${OPTARG};;
        h) showHelp;;
    esac
done ; shift $((OPTIND-1))

# have to be run as root
if [ `id -u` -ne 0 ] ; then echo "$0 have to be run as root!" ; exit 1 ; fi

#********************************************************************************
# search for the tool to create a group
PRG=$(which groupadd 2>/dev/null) || \
PRG=$(which addgroup 2>/dev/null) || \
PRG=$(which pw 2>/dev/null)
# FreeBSD's tool 'pw' is special: 'pw groupadd -g 200 -n qmail'
if [ "$PRG" ] && [ $PRG = "/usr/sbin/pw" ] ; then PRG="$PRG groupadd" ; N="-n" ; fi
# Error:
[ "$PRG" ] || ErrMsg="Didn't know how to add groups! Aborting!"
[ "$ErrMsg" ] && Error

# creating groups
if [ $STARTGID ] ; then GID="$STARTGID" ; PRG=$PRG" -g" ; fi
for G in `head -2 conf-groups`
do
  $PRG $GID $N $G && echo "Added group $G"
  [ $GID ] && GID=$(($GID+1))	# increment the next GID
done

#********************************************************************************
# search for the tool to create users (usually 'adduser 'or 'useradd')
PRG=$(which useradd 2>/dev/null) || \
PRG=$(which adduser 2>/dev/null)
# on FreeBSD we need pw and the '-n <user>' switch ( the cmd  is a bit different:
# '$> pw useradd -g qmail -s /bin/nologin -c "" -d /var/qmail -u 200 -n <user>' )
if [ `uname | tr '/:[A-Z]' '..[a-z]'` = "freebsd" ] ; then
   PRG=$(which pw 2>/dev/null)" useradd" ; N="-n" ; fi

# Error:
[ "$PRG" ] || ErrMsg="Didn't know how to create users! Aborting!"
[ "$ErrMsg" ] && Error

# users
HOME=`head -1 conf-qmail`
SYSTEM=$(uname | tr '[A-Z]' '[a-z]')
if [ $STARTUID ] ; then NUID="$STARTUID" ; fi
for U in `head -8 conf-users`
do
  i=$(($i+1))  # increment the loop counter
  if [ `id -u $U` 2>/dev/null -ne 0 ] ; then        # exclude UID 0 (root)
	H="-d $HOME" ; GID=`head -1 conf-groups`
    if [ $i -eq 1 ] ; then H="-d $HOME/alias" ; fi  # first one is the alias user
	# switch the group (the first 4 users have 'qmail', than 'nofiles')
    if [ $i -ge 5 ] ; then GID=`head -2 conf-groups | tail -1` ; fi
    [ $NEXTUID ] && SETUID="-u $NEXTUID"            # set the next UID to use
#    echo -n "$i: "
    # BSD prints an error if home dir doesn't exists w/o the '-m' switch
    if [ $SYSTEM != "linux" ] ; then H="" ; fi
    # Create the user
    $PRG -g $GID -s /sbin/nologin $SETUID -c "" $H $N $U && \
	echo "Added user $U with group $GID!"
    [ $NEXTUID ] && NUID=$(($NEXTUID+1))            # increment the next NUID
  fi
done
